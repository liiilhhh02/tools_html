<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mac-to-Windows ZIP 兼容性工具</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 JSZip 库用于创建 ZIP 文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 引入 FileSaver 库用于保存文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* 设置全局字体为 Inter，确保中文显示良好 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .drop-zone {
            border: 3px dashed #93c5fd; /* 浅蓝色边框 */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: #f0f9ff; /* 浅蓝背景 */
        }
        .drop-zone-active {
            border-color: #2563eb;
            background-color: #dbeafe;
        }
        .config-label {
            font-weight: 600;
            color: #374151;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 border border-gray-100">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mr-3" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            跨平台 ZIP 兼容工具
        </h1>
        <p class="text-gray-500 mb-8">
            上传您的文件/文件夹。本工具专用于解决 Mac 到 Windows 的乱码问题，通过 **排除 Mac 冗余文件** 和 **使用 UTF-8 编码** 来实现。
        </p>

        <!-- 文件拖放区域 -->
        <div id="dropZone" class="drop-zone p-12 text-center rounded-lg mb-6 hover:border-blue-600">
            <input type="file" id="fileInput" multiple webkitdirectory directory hidden>
            <p class="text-gray-700 font-semibold text-lg mb-2">将文件/文件夹拖到此处</p>
            <p class="text-sm text-blue-500">或</p>
            <button id="selectFilesBtn" class="mt-3 px-6 py-2 bg-blue-600 text-white font-medium rounded-full shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105">
                选择文件/文件夹
            </button>
        </div>

        <!-- 文件列表和操作区域 -->
        <div id="fileListContainer" class="hidden">
            <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-1">配置与压缩</h2>
            <div class="bg-gray-50 border border-gray-200 rounded-lg max-h-48 overflow-y-auto p-3 mb-6 shadow-inner">
                <h3 class="font-medium text-gray-600 mb-2">待压缩文件列表 (已排除 Mac 冗余文件)</h3>
                <ul id="fileList" class="space-y-1 text-sm text-gray-600 pl-4 list-disc">
                    <!-- 文件列表将在此处显示 -->
                </ul>
                <p id="fileCountSummary" class="text-xs text-gray-400 mt-2"></p>
            </div>
            
            <div class="space-y-4 mb-6">
                <!-- 压缩包文件名 -->
                <div>
                    <label for="zipFilename" class="block text-sm config-label mb-1">文件名</label>
                    <input type="text" id="zipFilename" value="Cross_Platform_Archive" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- 压缩格式选择 (仅 ZIP 兼容) -->
                <div>
                    <label for="compressionFormat" class="block text-sm config-label mb-1">压缩格式</label>
                    <div class="relative">
                        <select id="compressionFormat" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed appearance-none">
                            <option value="zip">ZIP (UTF-8 兼容) - 唯一支持格式</option>
                            <option value="7z" disabled>7Z (浏览器不支持)</option>
                            <option value="rar" disabled>RAR (浏览器不支持)</option>
                        </select>
                        <p class="text-xs text-red-600 mt-1 font-medium">注意：由于浏览器安全和单文件限制，目前仅支持 ZIP 格式。</p>
                    </div>
                </div>

                <!-- 密码保护 (不可用) -->
                <div>
                    <label for="zipPassword" class="block text-sm config-label mb-1">密码保护</label>
                    <input type="password" id="zipPassword" placeholder="输入密码 (暂不支持加密)" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" disabled>
                    <p class="text-xs text-red-600 mt-1 font-medium">注意：基于浏览器的 JSZip 库不支持加密功能，因此无法添加密码。</p>
                </div>
            </div>

            <button id="startZipBtn" class="w-full py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-xl hover:bg-green-700 transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                开始生成兼容 ZIP
            </button>
        </div>

        <!-- 状态/通知区域 -->
        <div id="statusMessage" class="mt-6 p-4 rounded-lg text-sm bg-blue-50 text-blue-700 hidden">
            <!-- 状态消息将在此处显示 -->
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const startZipBtn = document.getElementById('startZipBtn');
        const zipFilenameInput = document.getElementById('zipFilename');
        const statusMessage = document.getElementById('statusMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const fileCountSummary = document.getElementById('fileCountSummary');

        let filesToArchive = [];

        // 1. 文件过滤逻辑
        const isMacJunk = (path) => {
            // 排除 .DS_Store
            if (path.endsWith('/.DS_Store')) return true;
            // 排除 Mac 资源叉文件 (._*)
            if (path.match(/\/\._[^/]+$/)) return true;
            // 排除 __MACOSX 目录 (虽然 JSZip 不会创建，但以防万一)
            if (path.includes('__MACOSX/')) return true;
            return false;
        };

        // 2. 处理文件列表
        const handleFiles = (files) => {
            filesToArchive = [];
            fileList.innerHTML = '';
            
            // 将 FileList 转换为 Array
            const fileArray = Array.from(files);
            let junkCount = 0;

            // 递归处理文件（主要用于文件夹拖入）
            fileArray.forEach(file => {
                // 确保文件有路径信息 (WebkitDirectory/Drop event property)
                const fullPath = file.webkitRelativePath || file.name;
                
                // 过滤 Mac 垃圾文件
                if (isMacJunk(fullPath)) {
                    junkCount++;
                    return;
                }

                // 收集有效文件
                filesToArchive.push(file);

                // 在列表中显示文件名
                const listItem = document.createElement('li');
                listItem.textContent = fullPath;
                fileList.appendChild(listItem);
            });

            // 更新 UI
            if (filesToArchive.length > 0) {
                fileListContainer.classList.remove('hidden');
                startZipBtn.disabled = false;
                fileCountSummary.textContent = `总共 ${filesToArchive.length} 个有效文件；已自动过滤 ${junkCount} 个 Mac 冗余文件。`;
                showStatus(`已选择 ${filesToArchive.length} 个文件/文件夹，Mac 冗余文件已自动过滤。`, 'blue');
            } else {
                fileListContainer.classList.add('hidden');
                startZipBtn.disabled = true;
                fileCountSummary.textContent = `未选择文件或所有文件都是 Mac 冗余文件。`;
                showStatus('请选择有效的文件或文件夹。', 'red');
            }
        };

        // 3. 状态信息显示
        const showStatus = (message, type = 'blue') => {
            statusMessage.textContent = message;
            statusMessage.className = `mt-6 p-4 rounded-lg text-sm bg-${type}-50 text-${type}-700`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000); // 5秒后自动隐藏
        };

        // 4. 创建 ZIP 文件的核心功能
        const createZip = async () => {
            if (filesToArchive.length === 0) return;

            // 检查密码字段，并提供警告，因为加密功能不可用
            const passwordInput = document.getElementById('zipPassword');
            if (passwordInput.value.trim() !== "") {
                 showStatus('警告：密码输入框中的内容将被忽略，因为基于浏览器的 ZIP 库不支持加密功能。文件将以非加密方式压缩。', 'yellow');
                 // 清空密码输入框，避免误解
                 passwordInput.value = "";
            }


            startZipBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            startZipBtn.childNodes[startZipBtn.childNodes.length - 1].nodeValue = '  正在压缩...请等待  ';
            showStatus('开始创建 ZIP 压缩包，这可能需要一些时间...', 'yellow');

            const zip = new JSZip();
            
            // 遍历并添加到 ZIP
            filesToArchive.forEach(file => {
                const fullPath = file.webkitRelativePath || file.name;
                
                // 默认使用 UTF-8 编码处理文件名，这是解决乱码的关键
                zip.file(fullPath, file, { binary: true });
            });

            try {
                // 生成 ZIP 文件 (Type: Blob)
                const zipBlob = await zip.generateAsync({ 
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 9 },
                    // JSZip 默认使用 UTF-8 编码，确保跨平台兼容性
                });

                // 准备文件名
                let filename = zipFilenameInput.value.trim() || "Archive";
                if (!filename.toLowerCase().endsWith('.zip')) {
                    filename += '.zip';
                }

                // 使用 FileSaver.js 保存文件
                saveAs(zipBlob, filename);

                showStatus(`成功创建兼容 ZIP 文件: ${filename}，已开始下载。`, 'green');

            } catch (error) {
                console.error('ZIP Creation Error:', error);
                showStatus('压缩过程中发生错误，请检查文件大小或重试。', 'red');
            } finally {
                startZipBtn.disabled = false;
                loadingSpinner.classList.add('hidden');
                startZipBtn.childNodes[startZipBtn.childNodes.length - 1].nodeValue = '  开始生成兼容 ZIP  ';
            }
        };

        // 5. 事件监听器设置

        // 监听文件输入改变
        fileInput.addEventListener('change', (event) => {
            handleFiles(event.target.files);
        });

        // 监听文件选择按钮
        selectFilesBtn.addEventListener('click', () => {
            // 通过 click() 触发文件选择器
            fileInput.click();
        });

        // 监听拖放区域
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drop-zone-active');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drop-zone-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drop-zone-active');
            
            // 从 dataTransfer 对象获取文件
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        // 监听开始压缩按钮
        startZipBtn.addEventListener('click', createZip);

    </script>
</body>
</html>
